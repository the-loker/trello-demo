import{s as R,k as y,j as H,x as O,H as D,l as E,d as C,y as J,o as g,c as w,b as v,t as k,h as p,z,A as K,B as Q,C as Z,D as tt,E as P,m as et,F as L,n as V,p as ot,q as I,i as T,v as rt,G as nt,I as q,a as st}from"./index-DhxZ2PwS.js";import{c as at,a as ct}from"./index.esm-BqjAheMm.js";const it=R("stagesStore",()=>({stages:y([{id:"0",title:"on-hold"},{id:"1",title:"in-progress"},{id:"2",title:"needs-review"},{id:"3",title:"approved"}])})),lt=()=>{const{stages:t}=it();return{stages:t}},ut={stage:{type:Object,required:!0}};function $(t){localStorage.setItem("cards",JSON.stringify(t))}function dt(t){const e=localStorage.getItem("cards");if(e){const n=JSON.parse(e);for(const s in n)t[s]=n[s]}}const F=R("cardsStore",()=>{const t=H({});dt(t);async function e({row:i}){try{(await O(!0).get("cards/",{searchParams:{row:i}}).json()).forEach(r=>{t[r.id]=r})}catch(o){if(o instanceof D){const r=await o.response.json();if(r.detail)throw new Error(r.detail)}throw o}}async function n({row:i,text:o}){try{const r=Object.values(t).filter(d=>d.row===i).sort((d,f)=>d.seq_num-f.seq_num).length,c=await O(!0).post("cards/",{json:{row:i,seq_num:r,text:o}}).json();t[c.id]=c,$(t)}catch(r){if(r instanceof D){if(r.response.status===400)throw new Error("Incorrect card data");const c=await r.response.json();if(c.detail)throw new Error(c.detail)}throw r}}async function s({cardId:i,row:o,seq_num:r,text:c}){const d={...t[i]};try{t[i].row=o;const f=await O(!0).patch(`cards/${i}`,{json:{row:o,seq_num:r,text:c}}).json();t[f.id]=f,$(t)}catch(f){if(t[i]=d,f instanceof D){const l=await f.response.json();if(l.detail)throw new Error(l.detail)}throw f}}async function u(i){try{await O(!0).delete(`cards/${i}/`),delete t[i],$(t)}catch(o){if(o instanceof D){const r=await o.response.json();if(r.detail)throw new Error(r.detail)}throw o}}return{cards:t,getCards:e,create:n,update:s,remove:u}}),ft=t=>{const{cards:e,getCards:n,update:s}=F(),u=E(()=>Object.values(e).filter(r=>r.row===t.stage.id).sort((r,c)=>r.seq_num-c.seq_num)),i=E(()=>u.value.length);async function o(r,c){if(r.dataTransfer){const d=JSON.parse(r.dataTransfer.getData("card"));if(d.row===c)return;try{await s({cardId:d.id,row:c,seq_num:d.seq_num,text:d.text})}catch(f){console.error(f)}}}return{stageCards:u,getCards:n,countStageCards:i,onDrop:o}},pt={card:{type:Object,required:!0}},mt=t=>{const{remove:e}=F(),n=y(!1);async function s(){n.value=!0;try{await e(t.card.id)}catch(o){if(o instanceof Error)return alert(o.message);console.error(o)}finally{n.value=!1}}function u(o,r){const c=o.target;o.dataTransfer&&(o.dataTransfer.dropEffect="move",o.dataTransfer.effectAllowed="move",o.dataTransfer.setData("card",JSON.stringify(r))),setTimeout(()=>{c.style.visibility="hidden"},0)}function i(o){const r=o.target;r.style.visibility=""}return{isLoading:n,onRemove:s,onDragStart:u,onDragStop:i}},vt={class:"board-card__header"},gt={class:"board-card__header-title"},_t=v("span",{class:"board-card__id"},"id:",-1),wt=["disabled"],yt={class:"board-card__content"},ht=C({__name:"board-card",props:pt,setup(t){const e=t,{isLoading:n,onRemove:s,onDragStart:u,onDragStop:i}=mt(e),{card:o}=J(e);return(r,c)=>(g(),w("div",{onDragstart:c[1]||(c[1]=d=>p(u)(d,p(o))),onDragend:c[2]||(c[2]=d=>p(i)(d)),class:"board-card",draggable:"true"},[v("div",vt,[v("div",gt,[_t,v("span",null,k(p(o).id),1)]),v("button",{onClick:c[0]||(c[0]=(...d)=>p(s)&&p(s)(...d)),disabled:p(n),class:"button button--icon"}," ✕ ",8,wt)]),v("div",yt,k(p(o).text),1)],32))}});function G(t){return z()?(K(t),!0):!1}function b(t){return typeof t=="function"?t():p(t)}const U=typeof window<"u"&&typeof document<"u";typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;const bt=Object.prototype.toString,St=t=>bt.call(t)==="[object Object]",S=()=>{},B=Et();function Et(){var t,e;return U&&((t=window==null?void 0:window.navigator)==null?void 0:t.userAgent)&&(/iP(ad|hone|od)/.test(window.navigator.userAgent)||((e=window==null?void 0:window.navigator)==null?void 0:e.maxTouchPoints)>2&&/iPad|Macintosh/.test(window==null?void 0:window.navigator.userAgent))}const N={mounted:"mounted",updated:"updated",unmounted:"unmounted"};function kt(...t){if(t.length!==1)return Q(...t);const e=t[0];return typeof e=="function"?Z(tt(()=>({get:e,set:S}))):y(e)}function h(t){var e;const n=b(t);return(e=n==null?void 0:n.$el)!=null?e:n}const Y=U?window:void 0;function j(...t){let e,n,s,u;if(typeof t[0]=="string"||Array.isArray(t[0])?([n,s,u]=t,e=Y):[e,n,s,u]=t,!e)return S;Array.isArray(n)||(n=[n]),Array.isArray(s)||(s=[s]);const i=[],o=()=>{i.forEach(f=>f()),i.length=0},r=(f,l,a,m)=>(f.addEventListener(l,a,m),()=>f.removeEventListener(l,a,m)),c=P(()=>[h(e),b(u)],([f,l])=>{if(o(),!f)return;const a=St(l)?{...l}:l;i.push(...n.flatMap(m=>s.map(_=>r(f,m,_,a))))},{immediate:!0,flush:"post"}),d=()=>{c(),o()};return G(d),d}let W=!1;function M(t,e,n={}){const{window:s=Y,ignore:u=[],capture:i=!0,detectIframe:o=!1}=n;if(!s)return S;B&&!W&&(W=!0,Array.from(s.document.body.children).forEach(a=>a.addEventListener("click",S)),s.document.documentElement.addEventListener("click",S));let r=!0;const c=a=>u.some(m=>{if(typeof m=="string")return Array.from(s.document.querySelectorAll(m)).some(_=>_===a.target||a.composedPath().includes(_));{const _=h(m);return _&&(a.target===_||a.composedPath().includes(_))}}),f=[j(s,"click",a=>{const m=h(t);if(!(!m||m===a.target||a.composedPath().includes(m))){if(a.detail===0&&(r=!c(a)),!r){r=!0;return}e(a)}},{passive:!0,capture:i}),j(s,"pointerdown",a=>{const m=h(t);r=!c(a)&&!!(m&&!a.composedPath().includes(m))},{passive:!0}),o&&j(s,"blur",a=>{setTimeout(()=>{var m;const _=h(t);((m=s.document.activeElement)==null?void 0:m.tagName)==="IFRAME"&&!(_!=null&&_.contains(s.document.activeElement))&&e(a)},0)})].filter(Boolean);return()=>f.forEach(a=>a())}const Ct={[N.mounted](t,e){const n=!e.modifiers.bubble;if(typeof e.value=="function")t.__onClickOutside_stop=M(t,e.value,{capture:n});else{const[s,u]=e.value;t.__onClickOutside_stop=M(t,s,Object.assign({capture:n},u))}},[N.unmounted](t){t.__onClickOutside_stop()}};function A(t){return typeof Window<"u"&&t instanceof Window?t.document.documentElement:typeof Document<"u"&&t instanceof Document?t.documentElement:t}function X(t){const e=window.getComputedStyle(t);if(e.overflowX==="scroll"||e.overflowY==="scroll"||e.overflowX==="auto"&&t.clientWidth<t.scrollWidth||e.overflowY==="auto"&&t.clientHeight<t.scrollHeight)return!0;{const n=t.parentNode;return!n||n.tagName==="BODY"?!1:X(n)}}function Ot(t){const e=t||window.event,n=e.target;return X(n)?!1:e.touches.length>1?!0:(e.preventDefault&&e.preventDefault(),!1)}const x=new WeakMap;function Dt(t,e=!1){const n=y(e);let s=null;P(kt(t),o=>{const r=A(b(o));if(r){const c=r;x.get(c)||x.set(c,c.style.overflow),n.value&&(c.style.overflow="hidden")}},{immediate:!0});const u=()=>{const o=A(b(t));!o||n.value||(B&&(s=j(o,"touchmove",r=>{Ot(r)},{passive:!1})),o.style.overflow="hidden",n.value=!0)},i=()=>{var o;const r=A(b(t));!r||!n.value||(B&&(s==null||s()),r.style.overflow=(o=x.get(r))!=null?o:"",x.delete(r),n.value=!1)};return G(i),E({get(){return n.value},set(o){o?u():i()}})}function xt(){let t=!1;const e=y(!1);return(n,s)=>{if(e.value=s.value,t)return;t=!0;const u=Dt(n,s.value);P(e,i=>u.value=i)}}xt();const jt={modelValue:{type:Boolean,required:!0},stageId:{type:String,required:!0}},Lt={"update:modelValue":t=>typeof t=="boolean","close-form":t=>typeof t=="boolean"},$t=(t,e)=>{const{create:n}=F(),s=E({get(){return t.modelValue},set(l){e("update:modelValue",l)}}),u=at({text:ct().label("Text").min(3).required()}),i=H({text:""}),o=y([]),r=E(()=>!!o.value.length);function c(){o.value=[]}async function d(){try{await u.validate(i,{abortEarly:!0}),await n({row:t.stageId,text:i.text}),s.value=!1}catch(l){if(l instanceof Error)return o.value.push(l.message);console.error(l)}}function f(){s.value=!1,e("close-form",s.value)}return{isOpen:s,formData:i,errors:o,hasErrors:r,clearErrors:c,onCreate:d,onCloseForm:f}},At={key:0,class:"errors"},Tt={class:"board-card-form__controls"},qt=v("button",{type:"submit",class:"button button--primary"}," Добавить карточку ",-1),Bt=C({__name:"board-card-form",props:jt,emits:Lt,setup(t,{emit:e}){const n=t,s=e,{formData:u,errors:i,hasErrors:o,clearErrors:r,onCreate:c,onCloseForm:d}=$t(n,s);return et(()=>r()),(f,l)=>(g(),w(L,null,[p(o)?(g(),w("div",At,[(g(!0),w(L,null,V(p(i),(a,m)=>(g(),w("div",{key:m,class:"errors__message"},[v("span",null,k(a),1)]))),128))])):ot("",!0),I((g(),w("form",{class:"board-card-form",onSubmit:l[2]||(l[2]=T((...a)=>p(c)&&p(c)(...a),["prevent"]))},[I(v("textarea",{"onUpdate:modelValue":l[0]||(l[0]=a=>p(u).text=a),class:"input",rows:"4",placeholder:"Текст карточки"},null,512),[[rt,p(u).text]]),v("div",Tt,[qt,v("button",{onClick:l[1]||(l[1]=T((...a)=>p(d)&&p(d)(...a),["prevent"])),class:"button button--danger"}," Отменить ")])],32)),[[p(Ct),p(d)]])],64))}}),Pt={class:"board-stage__header"},Vt={class:"board-stage__title"},Ft={class:"board-stage__cards"},It={class:"board-stage__form"},Nt=C({__name:"board-stage",props:ut,setup(t){const e=t,{stageCards:n,countStageCards:s,getCards:u,onDrop:i}=ft(e),{stage:o}=J(e),r=y(!1);nt(async()=>{try{await u({row:e.stage.id})}catch(f){throw f}});function c(){r.value=!0}function d(){r.value=!1}return(f,l)=>(g(),w("div",{onDrop:l[1]||(l[1]=a=>p(i)(a,p(o).id)),onDragover:l[2]||(l[2]=T(()=>{},["prevent"])),onDragenter:l[3]||(l[3]=()=>{}),class:"board-stage"},[v("div",Pt,[v("span",Vt,k(p(o).title)+" ("+k(p(s))+") ",1)]),v("div",Ft,[(g(!0),w(L,null,V(p(n),a=>(g(),q(ht,{key:a.id,card:a},null,8,["card"]))),128))]),v("div",It,[r.value?(g(),q(Bt,{key:0,modelValue:r.value,"onUpdate:modelValue":l[0]||(l[0]=a=>r.value=a),"stage-id":p(o).id,onCloseForm:d},null,8,["modelValue","stage-id"])):(g(),w("button",{key:1,onClick:c,class:"button button--primary"}," Добавить карточку "))])],32))}}),Wt=C({__name:"board-stages",setup(t){const{stages:e}=lt();return(n,s)=>(g(!0),w(L,null,V(p(e),u=>(g(),q(Nt,{key:u.id,stage:u},null,8,["stage"]))),128))}}),Mt={class:"board"},Jt=C({__name:"Board",setup(t){return(e,n)=>(g(),w("div",Mt,[st(Wt)]))}});export{Jt as default};
