import{c as q,a as h}from"./index.esm-BqjAheMm.js";import{s as J,k as y,j as G,x as D,H as x,l as E,d as O,y as U,o as g,c as w,b as v,t as C,h as f,z as Q,A as Z,B as tt,C as et,D as ot,E as F,m as rt,F as $,n as I,p as nt,q as W,i as B,v as st,G as at,I as ct,J as P,a as it}from"./index-CP_rKBGd.js";const lt=J("stagesStore",()=>{const t=q({id:h().default(""),title:h().default(""),colors:q({text_color:h().default("#fff"),bg_color:h().default("#1a1a1a")})});return{stages:y([{id:"0",title:"on-hold",colors:{text_color:"#fff",bg_color:"#fb7e46"}},{id:"1",title:"in-progress",colors:{text_color:"#fff",bg_color:"#2a92bf"}},{id:"2",title:"needs-review",colors:{text_color:"#fff",bg_color:"#f4ce46"}},{id:"3",title:"approved",colors:{text_color:"#fff",bg_color:"#01b962"}}].map(s=>t.cast(s)))}}),ut=()=>{const{stages:t}=lt();return{stages:t}},dt={stage:{type:Object,required:!0}};function A(t){localStorage.setItem("cards",JSON.stringify(t))}function ft(t){const e=localStorage.getItem("cards");if(e){const n=JSON.parse(e);for(const s in n)t[s]=n[s]}}const N=J("cardsStore",()=>{const t=G({});ft(t);async function e({row:i}){try{(await D(!0).get("cards/",{searchParams:{row:i}}).json()).forEach(r=>{t[r.id]=r})}catch(o){if(o instanceof x){const r=await o.response.json();if(r.detail)throw new Error(r.detail)}throw o}}async function n({row:i,text:o}){try{const r=Object.values(t).filter(d=>d.row===i).sort((d,p)=>d.seq_num-p.seq_num).length,c=await D(!0).post("cards/",{json:{row:i,seq_num:r,text:o}}).json();t[c.id]=c,A(t)}catch(r){if(r instanceof x){if(r.response.status===400)throw new Error("Incorrect card data");const c=await r.response.json();if(c.detail)throw new Error(c.detail)}throw r}}async function s({cardId:i,row:o,seq_num:r,text:c}){const d={...t[i]};try{t[i].row=o;const p=await D(!0).patch(`cards/${i}`,{json:{row:o,seq_num:r,text:c}}).json();t[p.id]=p,A(t)}catch(p){if(t[i]=d,p instanceof x){const l=await p.response.json();if(l.detail)throw new Error(l.detail)}throw p}}async function u(i){try{await D(!0).delete(`cards/${i}/`),delete t[i],A(t)}catch(o){if(o instanceof x){const r=await o.response.json();if(r.detail)throw new Error(r.detail)}throw o}}return{cards:t,getCards:e,create:n,update:s,remove:u}}),pt=t=>{const{cards:e,getCards:n,update:s}=N(),u=E(()=>Object.values(e).filter(r=>r.row===t.stage.id).sort((r,c)=>r.seq_num-c.seq_num)),i=E(()=>u.value.length);async function o(r,c){if(r.dataTransfer){const d=JSON.parse(r.dataTransfer.getData("card"));if(d.row===c)return;try{await s({cardId:d.id,row:c,seq_num:d.seq_num,text:d.text})}catch(p){console.error(p)}}}return{stageCards:u,getCards:n,countStageCards:i,onDrop:o}},mt={card:{type:Object,required:!0}},vt=t=>{const{remove:e}=N(),n=y(!1);async function s(){n.value=!0;try{await e(t.card.id)}catch(o){if(o instanceof Error)return alert(o.message);console.error(o)}finally{n.value=!1}}function u(o,r){const c=o.target;o.dataTransfer&&(o.dataTransfer.dropEffect="move",o.dataTransfer.effectAllowed="move",o.dataTransfer.setData("card",JSON.stringify(r))),setTimeout(()=>{c.style.visibility="hidden"},0)}function i(o){const r=o.target;r.style.visibility=""}return{isLoading:n,onRemove:s,onDragStart:u,onDragStop:i}},gt={class:"board-card__header"},_t={class:"board-card__header-title"},wt=v("span",{class:"board-card__id"},"id:",-1),yt=["disabled"],ht={class:"board-card__content"},bt=O({__name:"board-card",props:mt,setup(t){const e=t,{isLoading:n,onRemove:s,onDragStart:u,onDragStop:i}=vt(e),{card:o}=U(e);return(r,c)=>(g(),w("div",{onDragstart:c[1]||(c[1]=d=>f(u)(d,f(o))),onDragend:c[2]||(c[2]=d=>f(i)(d)),class:"board-card",draggable:"true"},[v("div",gt,[v("div",_t,[wt,v("span",null,C(f(o).id),1)]),v("button",{onClick:c[0]||(c[0]=(...d)=>f(s)&&f(s)(...d)),disabled:f(n),class:"button button--icon"}," ✕ ",8,yt)]),v("div",ht,C(f(o).text),1)],32))}});function Y(t){return Q()?(Z(t),!0):!1}function S(t){return typeof t=="function"?t():f(t)}const z=typeof window<"u"&&typeof document<"u";typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;const St=Object.prototype.toString,kt=t=>St.call(t)==="[object Object]",k=()=>{},V=Et();function Et(){var t,e;return z&&((t=window==null?void 0:window.navigator)==null?void 0:t.userAgent)&&(/iP(ad|hone|od)/.test(window.navigator.userAgent)||((e=window==null?void 0:window.navigator)==null?void 0:e.maxTouchPoints)>2&&/iPad|Macintosh/.test(window==null?void 0:window.navigator.userAgent))}const M={mounted:"mounted",updated:"updated",unmounted:"unmounted"};function Ct(...t){if(t.length!==1)return tt(...t);const e=t[0];return typeof e=="function"?et(ot(()=>({get:e,set:k}))):y(e)}function b(t){var e;const n=S(t);return(e=n==null?void 0:n.$el)!=null?e:n}const X=z?window:void 0;function L(...t){let e,n,s,u;if(typeof t[0]=="string"||Array.isArray(t[0])?([n,s,u]=t,e=X):[e,n,s,u]=t,!e)return k;Array.isArray(n)||(n=[n]),Array.isArray(s)||(s=[s]);const i=[],o=()=>{i.forEach(p=>p()),i.length=0},r=(p,l,a,m)=>(p.addEventListener(l,a,m),()=>p.removeEventListener(l,a,m)),c=F(()=>[b(e),S(u)],([p,l])=>{if(o(),!p)return;const a=kt(l)?{...l}:l;i.push(...n.flatMap(m=>s.map(_=>r(p,m,_,a))))},{immediate:!0,flush:"post"}),d=()=>{c(),o()};return Y(d),d}let R=!1;function H(t,e,n={}){const{window:s=X,ignore:u=[],capture:i=!0,detectIframe:o=!1}=n;if(!s)return k;V&&!R&&(R=!0,Array.from(s.document.body.children).forEach(a=>a.addEventListener("click",k)),s.document.documentElement.addEventListener("click",k));let r=!0;const c=a=>u.some(m=>{if(typeof m=="string")return Array.from(s.document.querySelectorAll(m)).some(_=>_===a.target||a.composedPath().includes(_));{const _=b(m);return _&&(a.target===_||a.composedPath().includes(_))}}),p=[L(s,"click",a=>{const m=b(t);if(!(!m||m===a.target||a.composedPath().includes(m))){if(a.detail===0&&(r=!c(a)),!r){r=!0;return}e(a)}},{passive:!0,capture:i}),L(s,"pointerdown",a=>{const m=b(t);r=!c(a)&&!!(m&&!a.composedPath().includes(m))},{passive:!0}),o&&L(s,"blur",a=>{setTimeout(()=>{var m;const _=b(t);((m=s.document.activeElement)==null?void 0:m.tagName)==="IFRAME"&&!(_!=null&&_.contains(s.document.activeElement))&&e(a)},0)})].filter(Boolean);return()=>p.forEach(a=>a())}const Ot={[M.mounted](t,e){const n=!e.modifiers.bubble;if(typeof e.value=="function")t.__onClickOutside_stop=H(t,e.value,{capture:n});else{const[s,u]=e.value;t.__onClickOutside_stop=H(t,s,Object.assign({capture:n},u))}},[M.unmounted](t){t.__onClickOutside_stop()}};function T(t){return typeof Window<"u"&&t instanceof Window?t.document.documentElement:typeof Document<"u"&&t instanceof Document?t.documentElement:t}function K(t){const e=window.getComputedStyle(t);if(e.overflowX==="scroll"||e.overflowY==="scroll"||e.overflowX==="auto"&&t.clientWidth<t.scrollWidth||e.overflowY==="auto"&&t.clientHeight<t.scrollHeight)return!0;{const n=t.parentNode;return!n||n.tagName==="BODY"?!1:K(n)}}function Dt(t){const e=t||window.event,n=e.target;return K(n)?!1:e.touches.length>1?!0:(e.preventDefault&&e.preventDefault(),!1)}const j=new WeakMap;function xt(t,e=!1){const n=y(e);let s=null;F(Ct(t),o=>{const r=T(S(o));if(r){const c=r;j.get(c)||j.set(c,c.style.overflow),n.value&&(c.style.overflow="hidden")}},{immediate:!0});const u=()=>{const o=T(S(t));!o||n.value||(V&&(s=L(o,"touchmove",r=>{Dt(r)},{passive:!1})),o.style.overflow="hidden",n.value=!0)},i=()=>{var o;const r=T(S(t));!r||!n.value||(V&&(s==null||s()),r.style.overflow=(o=j.get(r))!=null?o:"",j.delete(r),n.value=!1)};return Y(i),E({get(){return n.value},set(o){o?u():i()}})}function jt(){let t=!1;const e=y(!1);return(n,s)=>{if(e.value=s.value,t)return;t=!0;const u=xt(n,s.value);F(e,i=>u.value=i)}}jt();const Lt={modelValue:{type:Boolean,required:!0},stageId:{type:String,required:!0}},$t={"update:modelValue":t=>typeof t=="boolean","close-form":t=>typeof t=="boolean"},At=(t,e)=>{const{create:n}=N(),s=E({get(){return t.modelValue},set(l){e("update:modelValue",l)}}),u=q({text:h().label("Text").min(3).required()}),i=G({text:""}),o=y([]),r=E(()=>!!o.value.length);function c(){o.value=[]}async function d(){try{await u.validate(i,{abortEarly:!0}),await n({row:t.stageId,text:i.text}),s.value=!1}catch(l){if(l instanceof Error)return o.value.push(l.message);console.error(l)}}function p(){s.value=!1,e("close-form",s.value)}return{isOpen:s,formData:i,errors:o,hasErrors:r,clearErrors:c,onCreate:d,onCloseForm:p}},Tt={key:0,class:"errors"},qt={class:"board-card-form__controls"},Bt=v("button",{type:"submit",class:"button button--primary"}," Добавить карточку ",-1),Pt=O({__name:"board-card-form",props:Lt,emits:$t,setup(t,{emit:e}){const n=t,s=e,{formData:u,errors:i,hasErrors:o,clearErrors:r,onCreate:c,onCloseForm:d}=At(n,s);return rt(()=>r()),(p,l)=>(g(),w($,null,[f(o)?(g(),w("div",Tt,[(g(!0),w($,null,I(f(i),(a,m)=>(g(),w("div",{key:m,class:"errors__message"},[v("span",null,C(a),1)]))),128))])):nt("",!0),W((g(),w("form",{class:"board-card-form",onSubmit:l[2]||(l[2]=B((...a)=>f(c)&&f(c)(...a),["prevent"]))},[W(v("textarea",{"onUpdate:modelValue":l[0]||(l[0]=a=>f(u).text=a),class:"input",rows:"4",placeholder:"Текст карточки"},null,512),[[st,f(u).text]]),v("div",qt,[Bt,v("button",{onClick:l[1]||(l[1]=B((...a)=>f(d)&&f(d)(...a),["prevent"])),class:"button button--danger"}," Отменить ")])],32)),[[f(Ot),f(d)]])],64))}}),Vt={class:"board-stage__title"},Ft={class:"board-stage__cards"},It={class:"board-stage__form"},Nt=O({__name:"board-stage",props:dt,setup(t){const e=t,{stageCards:n,countStageCards:s,getCards:u,onDrop:i}=pt(e),{stage:o}=U(e),r=y(!1);at(async()=>{try{await u({row:e.stage.id})}catch(p){throw p}});function c(){r.value=!0}function d(){r.value=!1}return console.log(o.value),(p,l)=>(g(),w("div",{onDrop:l[1]||(l[1]=a=>f(i)(a,f(o).id)),onDragover:l[2]||(l[2]=B(()=>{},["prevent"])),onDragenter:l[3]||(l[3]=()=>{}),class:"board-stage"},[v("div",{class:"board-stage__header",style:ct({color:f(o).colors.text_color,"background-color":f(o).colors.bg_color})},[v("span",Vt,C(f(o).title)+" ("+C(f(s))+") ",1)],4),v("div",Ft,[(g(!0),w($,null,I(f(n),a=>(g(),P(bt,{key:a.id,card:a},null,8,["card"]))),128))]),v("div",It,[r.value?(g(),P(Pt,{key:0,modelValue:r.value,"onUpdate:modelValue":l[0]||(l[0]=a=>r.value=a),"stage-id":f(o).id,onCloseForm:d},null,8,["modelValue","stage-id"])):(g(),w("button",{key:1,onClick:c,class:"button button--primary"}," Добавить карточку "))])],32))}}),Wt=O({__name:"board-stages",setup(t){const{stages:e}=ut();return(n,s)=>(g(!0),w($,null,I(f(e),u=>(g(),P(Nt,{key:u.id,stage:u},null,8,["stage"]))),128))}}),Mt={class:"board"},Jt=O({__name:"Board",setup(t){return(e,n)=>(g(),w("div",Mt,[it(Wt)]))}});export{Jt as default};
